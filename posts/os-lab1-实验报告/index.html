<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OS Lab1 实验报告 | My New Hugo Site</title><meta name=keywords content><meta name=description content="OS-lab1-实验报告 一、思考题 Thinking 1.1
题面：
请阅读附录中的编译链接详解，尝试分别使用实验环境中的原生 x86 工具 链（gcc、ld、readelf、objdump 等）和 MIPS 交叉编译工具链（带有 mips-linux-gnu前缀），重复其中的编译和解析过程，观察相应的结果，并解释其中向 objdump 传入的参 数的含义。 解答：
objdump中参数：
--disassemble -d 从objfile中反汇编那些特定指令机器码的section。 -D --disassemble-all 与 -d 类似，但反汇编所有section. -s --full-contents 显示指定section的完整内容。默认所有的非空section都会被显示。 -S --source 尽可能反汇编出源代码，尤其当编译的时候指定了-g这种调试参数时，效果比较明显。隐含了-d参数。 对于一个文件test.c：
int a = 3; char b; int main() { int c = 12; char* s = &#34;hello,world&#34;; return 0; } 先对其进行编译但不链接，并进行反汇编：
mips-linux-gnu-gcc -c test.c mips-linux-gnu-objdump -DS test.o > test.txt test.txt内容如下：
Disassembly of section .text: 00000000 <main>: 0: 3c1c0000 lui gp,0x0 4: 279c0000 addiu gp,gp,0 8: 0399e021 addu gp,gp,t9 c: 27bdffe8 addiu sp,sp,-24 10: afbe0010 sw s8,16(sp) 14: 03a0f021 move s8,sp 18: 2402000c li v0,12 1c: afc2000c sw v0,12(s8) 20: 8f820000 lw v0,0(gp) 24: 24420000 addiu v0,v0,0 28: afc20008 sw v0,8(s8) 2c: 00001021 move v0,zero 30: 03c0e821 move sp,s8 34: 8fbe0010 lw s8,16(sp) 38: 27bd0018 addiu sp,sp,24 3c: 03e00008 jr ra 40: 00000000 nop ."><meta name=author content><link rel=canonical href=https://illuminateC.github.io/myblog/posts/os-lab1-%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/><link crossorigin=anonymous href=/myblog/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/myblog/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://illuminateC.github.io/myblog/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://illuminateC.github.io/myblog/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://illuminateC.github.io/myblog/favicon-32x32.png><link rel=apple-touch-icon href=https://illuminateC.github.io/myblog/apple-touch-icon.png><link rel=mask-icon href=https://illuminateC.github.io/myblog/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="OS Lab1 实验报告"><meta property="og:description" content="OS-lab1-实验报告 一、思考题 Thinking 1.1
题面：
请阅读附录中的编译链接详解，尝试分别使用实验环境中的原生 x86 工具 链（gcc、ld、readelf、objdump 等）和 MIPS 交叉编译工具链（带有 mips-linux-gnu前缀），重复其中的编译和解析过程，观察相应的结果，并解释其中向 objdump 传入的参 数的含义。 解答：
objdump中参数：
--disassemble -d 从objfile中反汇编那些特定指令机器码的section。 -D --disassemble-all 与 -d 类似，但反汇编所有section. -s --full-contents 显示指定section的完整内容。默认所有的非空section都会被显示。 -S --source 尽可能反汇编出源代码，尤其当编译的时候指定了-g这种调试参数时，效果比较明显。隐含了-d参数。 对于一个文件test.c：
int a = 3; char b; int main() { int c = 12; char* s = &#34;hello,world&#34;; return 0; } 先对其进行编译但不链接，并进行反汇编：
mips-linux-gnu-gcc -c test.c mips-linux-gnu-objdump -DS test.o > test.txt test.txt内容如下：
Disassembly of section .text: 00000000 <main>: 0: 3c1c0000 lui gp,0x0 4: 279c0000 addiu gp,gp,0 8: 0399e021 addu gp,gp,t9 c: 27bdffe8 addiu sp,sp,-24 10: afbe0010 sw s8,16(sp) 14: 03a0f021 move s8,sp 18: 2402000c li v0,12 1c: afc2000c sw v0,12(s8) 20: 8f820000 lw v0,0(gp) 24: 24420000 addiu v0,v0,0 28: afc20008 sw v0,8(s8) 2c: 00001021 move v0,zero 30: 03c0e821 move sp,s8 34: 8fbe0010 lw s8,16(sp) 38: 27bd0018 addiu sp,sp,24 3c: 03e00008 jr ra 40: 00000000 nop ."><meta property="og:type" content="article"><meta property="og:url" content="https://illuminateC.github.io/myblog/posts/os-lab1-%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-28T13:27:06+08:00"><meta property="article:modified_time" content="2023-04-28T13:27:06+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="OS Lab1 实验报告"><meta name=twitter:description content="OS-lab1-实验报告 一、思考题 Thinking 1.1
题面：
请阅读附录中的编译链接详解，尝试分别使用实验环境中的原生 x86 工具 链（gcc、ld、readelf、objdump 等）和 MIPS 交叉编译工具链（带有 mips-linux-gnu前缀），重复其中的编译和解析过程，观察相应的结果，并解释其中向 objdump 传入的参 数的含义。 解答：
objdump中参数：
--disassemble -d 从objfile中反汇编那些特定指令机器码的section。 -D --disassemble-all 与 -d 类似，但反汇编所有section. -s --full-contents 显示指定section的完整内容。默认所有的非空section都会被显示。 -S --source 尽可能反汇编出源代码，尤其当编译的时候指定了-g这种调试参数时，效果比较明显。隐含了-d参数。 对于一个文件test.c：
int a = 3; char b; int main() { int c = 12; char* s = &#34;hello,world&#34;; return 0; } 先对其进行编译但不链接，并进行反汇编：
mips-linux-gnu-gcc -c test.c mips-linux-gnu-objdump -DS test.o > test.txt test.txt内容如下：
Disassembly of section .text: 00000000 <main>: 0: 3c1c0000 lui gp,0x0 4: 279c0000 addiu gp,gp,0 8: 0399e021 addu gp,gp,t9 c: 27bdffe8 addiu sp,sp,-24 10: afbe0010 sw s8,16(sp) 14: 03a0f021 move s8,sp 18: 2402000c li v0,12 1c: afc2000c sw v0,12(s8) 20: 8f820000 lw v0,0(gp) 24: 24420000 addiu v0,v0,0 28: afc20008 sw v0,8(s8) 2c: 00001021 move v0,zero 30: 03c0e821 move sp,s8 34: 8fbe0010 lw s8,16(sp) 38: 27bd0018 addiu sp,sp,24 3c: 03e00008 jr ra 40: 00000000 nop ."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://illuminateC.github.io/myblog/posts/"},{"@type":"ListItem","position":2,"name":"OS Lab1 实验报告","item":"https://illuminateC.github.io/myblog/posts/os-lab1-%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OS Lab1 实验报告","name":"OS Lab1 实验报告","description":"OS-lab1-实验报告 一、思考题 Thinking 1.1\n题面：\n请阅读附录中的编译链接详解，尝试分别使用实验环境中的原生 x86 工具 链（gcc、ld、readelf、objdump 等）和 MIPS 交叉编译工具链（带有 mips-linux-gnu前缀），重复其中的编译和解析过程，观察相应的结果，并解释其中向 objdump 传入的参 数的含义。 解答：\nobjdump中参数：\n--disassemble -d 从objfile中反汇编那些特定指令机器码的section。 -D --disassemble-all 与 -d 类似，但反汇编所有section. -s --full-contents 显示指定section的完整内容。默认所有的非空section都会被显示。 -S --source 尽可能反汇编出源代码，尤其当编译的时候指定了-g这种调试参数时，效果比较明显。隐含了-d参数。 对于一个文件test.c：\nint a = 3; char b; int main() { int c = 12; char* s = \u0026#34;hello,world\u0026#34;; return 0; } 先对其进行编译但不链接，并进行反汇编：\nmips-linux-gnu-gcc -c test.c mips-linux-gnu-objdump -DS test.o \u0026gt; test.txt test.txt内容如下：\nDisassembly of section .text: 00000000 \u0026lt;main\u0026gt;: 0: 3c1c0000 lui gp,0x0 4: 279c0000 addiu gp,gp,0 8: 0399e021 addu gp,gp,t9 c: 27bdffe8 addiu sp,sp,-24 10: afbe0010 sw s8,16(sp) 14: 03a0f021 move s8,sp 18: 2402000c li v0,12 1c: afc2000c sw v0,12(s8) 20: 8f820000 lw v0,0(gp) 24: 24420000 addiu v0,v0,0 28: afc20008 sw v0,8(s8) 2c: 00001021 move v0,zero 30: 03c0e821 move sp,s8 34: 8fbe0010 lw s8,16(sp) 38: 27bd0018 addiu sp,sp,24 3c: 03e00008 jr ra 40: 00000000 nop .","keywords":[],"articleBody":"OS-lab1-实验报告 一、思考题 Thinking 1.1\n题面：\n请阅读附录中的编译链接详解，尝试分别使用实验环境中的原生 x86 工具 链（gcc、ld、readelf、objdump 等）和 MIPS 交叉编译工具链（带有 mips-linux-gnu前缀），重复其中的编译和解析过程，观察相应的结果，并解释其中向 objdump 传入的参 数的含义。 解答：\nobjdump中参数：\n--disassemble -d 从objfile中反汇编那些特定指令机器码的section。 -D --disassemble-all 与 -d 类似，但反汇编所有section. -s --full-contents 显示指定section的完整内容。默认所有的非空section都会被显示。 -S --source 尽可能反汇编出源代码，尤其当编译的时候指定了-g这种调试参数时，效果比较明显。隐含了-d参数。 对于一个文件test.c：\nint a = 3; char b; int main() { int c = 12; char* s = \"hello,world\"; return 0; } 先对其进行编译但不链接，并进行反汇编：\nmips-linux-gnu-gcc -c test.c mips-linux-gnu-objdump -DS test.o \u003e test.txt test.txt内容如下：\nDisassembly of section .text: 00000000 : 0: 3c1c0000 lui gp,0x0 4: 279c0000 addiu gp,gp,0 8: 0399e021 addu gp,gp,t9 c: 27bdffe8 addiu sp,sp,-24 10: afbe0010 sw s8,16(sp) 14: 03a0f021 move s8,sp 18: 2402000c li v0,12 1c: afc2000c sw v0,12(s8) 20: 8f820000 lw v0,0(gp) 24: 24420000 addiu v0,v0,0 28: afc20008 sw v0,8(s8) 2c: 00001021 move v0,zero 30: 03c0e821 move sp,s8 34: 8fbe0010 lw s8,16(sp) 38: 27bd0018 addiu sp,sp,24 3c: 03e00008 jr ra 40: 00000000 nop ... 然后进行链接，并反汇编test\nmips-linux-gnu-ld hello.o -o test mips-linux-gnu-objdump -DS test \u003e test2.txt test2.txt的内容如下:\n004000b0 : 4000b0: 3c1c0fc0 lui gp,0xfc0 4000b4: 279c7f50 addiu gp,gp,32592 4000b8: 0399e021 addu gp,gp,t9 4000bc: 27bdffe8 addiu sp,sp,-24 4000c0: afbe0010 sw s8,16(sp) 4000c4: 03a0f021 move s8,sp 4000c8: 2402000c li v0,12 4000cc: afc2000c sw v0,12(s8) 4000d0: 8f828018 lw v0,-32744(gp) 4000d4: 24420100 addiu v0,v0,256 4000d8: afc20008 sw v0,8(s8) 4000dc: 00001021 move v0,zero 4000e0: 03c0e821 move sp,s8 4000e4: 8fbe0010 lw s8,16(sp) 4000e8: 27bd0018 addiu sp,sp,24 4000ec: 03e00008 jr ra 4000f0: 00000000 Thinking 1.2\n题面：\n思考下述问题： • 尝试使用我们编写的 readelf 程序，解析之前在 target 目录下生成的内核 ELF 文 件。 • 也许你会发现我们编写的 readelf 程序是不能解析 readelf 文件本身的，而我们刚 才介绍的系统工具 readelf 则可以解析，这是为什么呢？（提示：尝试使用 readelf -h，并阅读 tools/readelf 目录下的 Makefile，观察 readelf 与 hello 的不同）\n解答：\n原因：内核文件是大端存储，而我们的readelf程序解析的文件是小端存储的文件。\nThinking 1.3\n题面：\n在理论课上我们了解到，MIPS 体系结构上电时，启动入口地址为 0xBFC00000 （其实启动入口地址是根据具体型号而定的，由硬件逻辑确定，也有可能不是这个地址，但 一定是一个确定的地址），但实验操作系统的内核入口并没有放在上电启动地址，而是按照 内存布局图放置。思考为什么这样放置内核还能保证内核入口被正确跳转到？ （提示：思考实验中启动过程的两阶段分别由谁执行。） 解答：\n内核入口是_start函数在boot/start.S，main函数在init/main.c，内核启动先执行_start入口函数，然后从这个函数跳转到main函数，从start.S文件中jal mips_init命令可以看出。这样内核启动的入口地址就可以固定下来，只需要传递main函数的地址就可以实现不同位置的main函数的调用。\n二、难点分析 本次实验遇到的难点在Exercise1.4中vprintfmt函数的设计：\n​\t1.fmt每次完成匹配后需要自增使其指向下一个待检查的字符。\n​\t2.对于flag的匹配注意-和0可以同时出现。\n​\t当flag为-时：在给定的宽度(width)上左对齐输出，默认为右对齐。 ​\t当flag为0时：当输出宽度和指定宽度不同的时候，在空白位置填充0。\n​\t3.每一次循环时，需要对所有标志位进行初始化。\n​\t4.print_num传入的数字默认为无符号数，对于%d和%D数据处理我们需要预先判断正负。\n实现代码如下：\n#include /* forward declaration */ static void print_char(fmt_callback_t, void *, char, int, int); static void print_str(fmt_callback_t, void *, const char *, int, int); static void print_num(fmt_callback_t, void *, unsigned long, int, int, int, int, char, int); void vprintfmt(fmt_callback_t out, void *data, const char *fmt, va_list ap) { char c; const char *s; long num; int width; int long_flag; // output is long (rather than int) int neg_flag; // output is negative int ladjust; // output is left-aligned char padc; // padding char for (;;) { /* scan for the next '%' */ /* Exercise 1.4: Your code here. (1/8) */ const char *curfmt = fmt; while(1) { if(*curfmt == '\\0') break; if(*curfmt == '%') break; curfmt++; } out(data, fmt, curfmt-fmt); fmt = curfmt; /* flush the string found so far */ /* Exercise 1.4: Your code here. (2/8) */ if(*fmt == '\\0') break; /* check \"are we hitting the end?\" */ /* Exercise 1.4: Your code here. (3/8) */ fmt++; long_flag = 0; neg_flag = 0; width = 0; ladjust = 0; padc = ' '; /* we found a '%' */ /* Exercise 1.4: Your code here. (4/8) */ /* check format flag */ /* Exercise 1.4: Your code here. (5/8) */ if(*fmt == '-') ladjust = 1, fmt++; if(*fmt == '0') padc = '0', fmt++; /* get width */ /* Exercise 1.4: Your code here. (6/8) */ while (*fmt\u003c='9' \u0026\u0026 *fmt\u003e='0') { width = width*10 + (*fmt-'0'); fmt++; } /* check for long */ /* Exercise 1.4: Your code here. (7/8) */ if(*fmt == 'l') { long_flag = 1; fmt++; } neg_flag = 0; switch (*fmt) { case 'b': if (long_flag) { num = va_arg(ap, long int); } else { num = va_arg(ap, int); } print_num(out, data, num, 2, 0, width, ladjust, padc, 0); break; case 'd': case 'D': if (long_flag) { num = va_arg(ap, long int); } else { num = va_arg(ap, int); } /* * Refer to other parts (case 'b', case 'o', etc.) and func 'print_num' to * complete this part. Think the differences between case 'd' and the * others. (hint: 'neg_flag'). */ /* Exercise 1.4: Your code here. (8/8) */ if(num \u003c 0) { neg_flag = 1; num = -num; } print_num(out, data, num, 10, neg_flag, width, ladjust, padc, 0); break; case 'o': case 'O': if (long_flag) { num = va_arg(ap, long int); } else { num = va_arg(ap, int); } print_num(out, data, num, 8, 0, width, ladjust, padc, 0); break; case 'u': case 'U': if (long_flag) { num = va_arg(ap, long int); } else { num = va_arg(ap, int); } print_num(out, data, num, 10, 0, width, ladjust, padc, 0); break; case 'x': if (long_flag) { num = va_arg(ap, long int); } else { num = va_arg(ap, int); } print_num(out, data, num, 16, 0, width, ladjust, padc, 0); break; case 'X': if (long_flag) { num = va_arg(ap, long int); } else { num = va_arg(ap, int); } print_num(out, data, num, 16, 0, width, ladjust, padc, 1); break; case 'c': c = (char)va_arg(ap, int); print_char(out, data, c, width, ladjust); break; case 's': s = (char *)va_arg(ap, char *); print_str(out, data, s, width, ladjust); break; case '\\0': fmt--; break; default: /* output this char as it is */ out(data, fmt, 1); } fmt++; } } /* --------------- local help functions --------------------- */ void print_char(fmt_callback_t out, void *data, char c, int length, int ladjust) { int i; if (length \u003c 1) { length = 1; } const char space = ' '; if (ladjust) { out(data, \u0026c, 1); for (i = 1; i \u003c length; i++) { out(data, \u0026space, 1); } } else { for (i = 0; i \u003c length - 1; i++) { out(data, \u0026space, 1); } out(data, \u0026c, 1); } } void print_str(fmt_callback_t out, void *data, const char *s, int length, int ladjust) { int i; int len = 0; const char *s1 = s; while (*s1++) { len++; } if (length \u003c len) { length = len; } if (ladjust) { out(data, s, len); for (i = len; i \u003c length; i++) { out(data, \" \", 1); } } else { for (i = 0; i \u003c length - len; i++) { out(data, \" \", 1); } out(data, s, len); } } void print_num(fmt_callback_t out, void *data, unsigned long u, int base, int neg_flag, int length, int ladjust, char padc, int upcase) { /* algorithm : * 1. prints the number from left to right in reverse form. * 2. fill the remaining spaces with padc if length is longer than * the actual length * TRICKY : if left adjusted, no \"0\" padding. *\tif negtive, insert \"0\" padding between \"0\" and number. * 3. if (!ladjust) we reverse the whole string including paddings * 4. otherwise we only reverse the actual string representing the num. */ int actualLength = 0; char buf[length + 70]; char *p = buf; int i; do { int tmp = u % base; if (tmp \u003c= 9) { *p++ = '0' + tmp; } else if (upcase) { *p++ = 'A' + tmp - 10; } else { *p++ = 'a' + tmp - 10; } u /= base; } while (u != 0); if (neg_flag) { *p++ = '-'; } /* figure out actual length and adjust the maximum length */ actualLength = p - buf; if (length \u003c actualLength) { length = actualLength; } /* add padding */ if (ladjust) { padc = ' '; } if (neg_flag \u0026\u0026 !ladjust \u0026\u0026 (padc == '0')) { for (i = actualLength - 1; i \u003c length - 1; i++) { buf[i] = padc; } buf[length - 1] = '-'; } else { for (i = actualLength; i \u003c length; i++) { buf[i] = padc; } } /* prepare to reverse the string */ int begin = 0; int end; if (ladjust) { end = actualLength - 1; } else { end = length - 1; } /* adjust the string pointer */ while (end \u003e begin) { char tmp = buf[begin]; buf[begin] = buf[end]; buf[end] = tmp; begin++; end--; } out(data, buf, length); } 三、体会与感想 本次lab1花费了很长时间，主要有以下问题：\n​\t1.在实现print.c时需要阅读三个文件的代码，切换起来有些不方便，导致浪费了较多时间；\n​\t2.文件的每一个代码段，都大量使用宏定义和一些全局变量，需要手动grep去查找，虽然说这样是为了代码的可移植性，容错性更高，但是在实际阅读时仍然对于很多宏理解不清楚甚至混淆；\n​\t3.给出的代码一般都预先定义好了变量，但由于不能理解变量名称（比如不知道带ptr的变量是指针），我在面对一块待补充的部分时有些茫然，在学习了一些变量命名规范后发现给出的变量名已经暗中提示了相关的操作，甚至提示了变量的数据类型。\n往后的lab中，我一定要学习了解较多的预置知识，并且弄清楚其他的文件、宏定义、函数，了解各个文件、函数之间的层次关系，争取做到明晰多文件是如何划分的，它们又是怎么协同完成操作系统的启动的。\n","wordCount":"1296","inLanguage":"en","datePublished":"2023-04-28T13:27:06+08:00","dateModified":"2023-04-28T13:27:06+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://illuminateC.github.io/myblog/posts/os-lab1-%E5%AE%9E%E9%AA%8C%E6%8A%A5%E5%91%8A/"},"publisher":{"@type":"Organization","name":"My New Hugo Site","logo":{"@type":"ImageObject","url":"https://illuminateC.github.io/myblog/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://illuminateC.github.io/myblog/ accesskey=h title="My New Hugo Site (Alt + H)">My New Hugo Site</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>OS Lab1 实验报告</h1><div class=post-meta><span title='2023-04-28 13:27:06 +0800 +0800'>April 28, 2023</span></div></header><div class=post-content><h1 id=os-lab1-实验报告>OS-lab1-实验报告<a hidden class=anchor aria-hidden=true href=#os-lab1-实验报告>#</a></h1><h2 id=一思考题>一、思考题<a hidden class=anchor aria-hidden=true href=#一思考题>#</a></h2><ol><li><p>Thinking 1.1</p><p>题面：</p><p><code>请阅读附录中的编译链接详解，尝试分别使用实验环境中的原生 x86 工具 链（gcc、ld、readelf、objdump 等）和 MIPS 交叉编译工具链（带有 mips-linux-gnu前缀），重复其中的编译和解析过程，观察相应的结果，并解释其中向 objdump 传入的参 数的含义。</code></p><p>解答：</p><p><code>objdump</code>中参数：</p><pre tabindex=0><code>--disassemble 
-d 
从objfile中反汇编那些特定指令机器码的section。 

-D 
--disassemble-all 
与 -d 类似，但反汇编所有section. 

-s 
--full-contents 
显示指定section的完整内容。默认所有的非空section都会被显示。 

-S 
--source 
尽可能反汇编出源代码，尤其当编译的时候指定了-g这种调试参数时，效果比较明显。隐含了-d参数。 
</code></pre><p>对于一个文件test.c：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>int</span> a <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> b;
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> c <span style=color:#f92672>=</span> <span style=color:#ae81ff>12</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hello,world&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>先对其进行编译但不链接，并进行反汇编：</p><pre tabindex=0><code>mips-linux-gnu-gcc -c test.c
mips-linux-gnu-objdump -DS test.o &gt; test.txt
</code></pre><p>test.txt内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>Disassembly of section .text:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>00000000 &lt;main&gt;:
</span></span><span style=display:flex><span>   0:   3c1c0000        lui     gp,0x0
</span></span><span style=display:flex><span>   4:   279c0000        addiu   gp,gp,0
</span></span><span style=display:flex><span>   8:   0399e021        addu    gp,gp,t9
</span></span><span style=display:flex><span>   c:   27bdffe8        addiu   sp,sp,-24
</span></span><span style=display:flex><span>  10:   afbe0010        sw      s8,16(sp)
</span></span><span style=display:flex><span>  14:   03a0f021        move    s8,sp
</span></span><span style=display:flex><span>  18:   2402000c        li      v0,12
</span></span><span style=display:flex><span>  1c:   afc2000c        sw      v0,12(s8)
</span></span><span style=display:flex><span>  20:   8f820000        lw      v0,0(gp)
</span></span><span style=display:flex><span>  24:   24420000        addiu   v0,v0,0
</span></span><span style=display:flex><span>  28:   afc20008        sw      v0,8(s8)
</span></span><span style=display:flex><span>  2c:   00001021        move    v0,zero
</span></span><span style=display:flex><span>  30:   03c0e821        move    sp,s8
</span></span><span style=display:flex><span>  34:   8fbe0010        lw      s8,16(sp)
</span></span><span style=display:flex><span>  38:   27bd0018        addiu   sp,sp,24
</span></span><span style=display:flex><span>  3c:   03e00008        jr      ra
</span></span><span style=display:flex><span>  40:   00000000        nop
</span></span><span style=display:flex><span>        ...
</span></span></code></pre></div><p>然后进行链接，并反汇编test</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mips-linux-gnu-ld hello.o -o test
</span></span><span style=display:flex><span>mips-linux-gnu-objdump -DS test &gt; test2.txt
</span></span></code></pre></div><p>test2.txt的内容如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>004000b0 &lt;main&gt;:
</span></span><span style=display:flex><span>  4000b0:       3c1c0fc0        lui     gp,0xfc0
</span></span><span style=display:flex><span>  4000b4:       279c7f50        addiu   gp,gp,32592
</span></span><span style=display:flex><span>  4000b8:       0399e021        addu    gp,gp,t9
</span></span><span style=display:flex><span>  4000bc:       27bdffe8        addiu   sp,sp,-24
</span></span><span style=display:flex><span>  4000c0:       afbe0010        sw      s8,16(sp)
</span></span><span style=display:flex><span>  4000c4:       03a0f021        move    s8,sp
</span></span><span style=display:flex><span>  4000c8:       2402000c        li      v0,12
</span></span><span style=display:flex><span>  4000cc:       afc2000c        sw      v0,12(s8)
</span></span><span style=display:flex><span>  4000d0:       8f828018        lw      v0,-32744(gp)
</span></span><span style=display:flex><span>  4000d4:       24420100        addiu   v0,v0,256
</span></span><span style=display:flex><span>  4000d8:       afc20008        sw      v0,8(s8)
</span></span><span style=display:flex><span>  4000dc:       00001021        move    v0,zero
</span></span><span style=display:flex><span>  4000e0:       03c0e821        move    sp,s8
</span></span><span style=display:flex><span>  4000e4:       8fbe0010        lw      s8,16(sp)
</span></span><span style=display:flex><span>  4000e8:       27bd0018        addiu   sp,sp,24
</span></span><span style=display:flex><span>  4000ec:       03e00008        jr      ra
</span></span><span style=display:flex><span>  4000f0:       00000000      
</span></span></code></pre></div></li><li><p>Thinking 1.2</p><p>题面：</p><p><code>思考下述问题： • 尝试使用我们编写的 readelf 程序，解析之前在 target 目录下生成的内核 ELF 文 件。 • 也许你会发现我们编写的 readelf 程序是不能解析 readelf 文件本身的，而我们刚 才介绍的系统工具 readelf 则可以解析，这是为什么呢？（提示：尝试使用 readelf -h，并阅读 tools/readelf 目录下的 Makefile，观察 readelf 与 hello 的不同）</code></p><p>解答：</p><p>原因：内核文件是大端存储，而我们的readelf程序解析的文件是小端存储的文件。</p></li><li><p>Thinking 1.3</p><p>题面：</p><p><code>在理论课上我们了解到，MIPS 体系结构上电时，启动入口地址为 0xBFC00000 （其实启动入口地址是根据具体型号而定的，由硬件逻辑确定，也有可能不是这个地址，但 一定是一个确定的地址），但实验操作系统的内核入口并没有放在上电启动地址，而是按照 内存布局图放置。思考为什么这样放置内核还能保证内核入口被正确跳转到？ （提示：思考实验中启动过程的两阶段分别由谁执行。）</code></p><p>解答：</p><p>内核入口是<code>_start</code>函数在boot/start.S，<code>main</code>函数在init/main.c，内核启动先执行<code>_start</code>入口函数，然后从这个函数跳转到<code>main</code>函数，从start.S文件中<code>jal mips_init</code>命令可以看出。这样内核启动的入口地址就可以固定下来，只需要传递<code>main</code>函数的地址就可以实现不同位置的<code>main</code>函数的调用。</p></li></ol><h2 id=二难点分析>二、难点分析<a hidden class=anchor aria-hidden=true href=#二难点分析>#</a></h2><p>本次实验遇到的难点在Exercise1.4中<code>vprintfmt</code>函数的设计：</p><p>​ 1.fmt每次完成匹配后需要自增使其指向下一个待检查的字符。</p><p>​ 2.对于flag的匹配注意<code>-</code>和<code>0</code>可以同时出现。</p><p>​ 当flag为<code>-</code>时：在给定的宽度(width)上左对齐输出，默认为右对齐。
​ 当flag为<code>0</code>时：当输出宽度和指定宽度不同的时候，在空白位置填充0。</p><p>​ 3.每一次循环时，需要对所有标志位进行初始化。</p><p>​ 4.<code>print_num</code>传入的数字默认为无符号数，对于%d和%D数据处理我们需要预先判断正负。</p><p>实现代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e>#include &lt;print.h&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/* forward declaration */
</span></span><span style=display:flex><span>static void print_char<span style=color:#f92672>(</span>fmt_callback_t, void *, char, int, int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>static void print_str<span style=color:#f92672>(</span>fmt_callback_t, void *, const char *, int, int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>static void print_num<span style=color:#f92672>(</span>fmt_callback_t, void *, unsigned long, int, int, int, int, char, int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>void vprintfmt<span style=color:#f92672>(</span>fmt_callback_t out, void *data, const char *fmt, va_list ap<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	char c;
</span></span><span style=display:flex><span>	const char *s;
</span></span><span style=display:flex><span>	long num;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	int width;
</span></span><span style=display:flex><span>	int long_flag; // output is long <span style=color:#f92672>(</span>rather than int<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>	int neg_flag;  // output is negative
</span></span><span style=display:flex><span>	int ladjust;   // output is left-aligned
</span></span><span style=display:flex><span>	char padc;     // padding char
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>;;<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		/* scan <span style=color:#66d9ef>for</span> the next <span style=color:#e6db74>&#39;%&#39;</span> */
</span></span><span style=display:flex><span>		/* Exercise 1.4: Your code here. <span style=color:#f92672>(</span>1/8<span style=color:#f92672>)</span> */
</span></span><span style=display:flex><span>		const char *curfmt <span style=color:#f92672>=</span> fmt;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>while</span><span style=color:#f92672>(</span>1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>*curfmt <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;\0&#39;</span><span style=color:#f92672>)</span> break;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>*curfmt <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;%&#39;</span><span style=color:#f92672>)</span> break;
</span></span><span style=display:flex><span>			curfmt++;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		out<span style=color:#f92672>(</span>data, fmt, curfmt-fmt<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>		fmt <span style=color:#f92672>=</span> curfmt;
</span></span><span style=display:flex><span>		/* flush the string found so far */
</span></span><span style=display:flex><span>		/* Exercise 1.4: Your code here. <span style=color:#f92672>(</span>2/8<span style=color:#f92672>)</span> */
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>*fmt <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;\0&#39;</span><span style=color:#f92672>)</span> break;
</span></span><span style=display:flex><span>		/* check <span style=color:#e6db74>&#34;are we hitting the end?&#34;</span> */
</span></span><span style=display:flex><span>		/* Exercise 1.4: Your code here. <span style=color:#f92672>(</span>3/8<span style=color:#f92672>)</span> */
</span></span><span style=display:flex><span>		fmt++;
</span></span><span style=display:flex><span>		long_flag <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>		neg_flag <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>		width <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>		ladjust <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>		padc <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39; &#39;</span>;
</span></span><span style=display:flex><span>		/* we found a <span style=color:#e6db74>&#39;%&#39;</span> */
</span></span><span style=display:flex><span>		/* Exercise 1.4: Your code here. <span style=color:#f92672>(</span>4/8<span style=color:#f92672>)</span> */
</span></span><span style=display:flex><span>		/* check format flag */
</span></span><span style=display:flex><span>		/* Exercise 1.4: Your code here. <span style=color:#f92672>(</span>5/8<span style=color:#f92672>)</span> */
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>*fmt <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;-&#39;</span><span style=color:#f92672>)</span> ladjust <span style=color:#f92672>=</span> 1, fmt++;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>*fmt <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;0&#39;</span><span style=color:#f92672>)</span> padc <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0&#39;</span>, fmt++;
</span></span><span style=display:flex><span>		/* get width */
</span></span><span style=display:flex><span>		/* Exercise 1.4: Your code here. <span style=color:#f92672>(</span>6/8<span style=color:#f92672>)</span> */
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>*fmt&lt;<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;9&#39;</span> <span style=color:#f92672>&amp;&amp;</span> *fmt&gt;<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;0&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			width <span style=color:#f92672>=</span> width*10 + <span style=color:#f92672>(</span>*fmt-<span style=color:#e6db74>&#39;0&#39;</span><span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			fmt++;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		/* check <span style=color:#66d9ef>for</span> long */
</span></span><span style=display:flex><span>		/* Exercise 1.4: Your code here. <span style=color:#f92672>(</span>7/8<span style=color:#f92672>)</span> */
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>*fmt <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;l&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			long_flag <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>			fmt++;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		neg_flag <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>		switch <span style=color:#f92672>(</span>*fmt<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;b&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>long_flag<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> va_arg<span style=color:#f92672>(</span>ap, long int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> va_arg<span style=color:#f92672>(</span>ap, int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			print_num<span style=color:#f92672>(</span>out, data, num, 2, 0, width, ladjust, padc, 0<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			break;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;d&#39;</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;D&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>long_flag<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> va_arg<span style=color:#f92672>(</span>ap, long int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> va_arg<span style=color:#f92672>(</span>ap, int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			/*
</span></span><span style=display:flex><span>			 * Refer to other parts <span style=color:#f92672>(</span><span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;b&#39;</span>, <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;o&#39;</span>, etc.<span style=color:#f92672>)</span> and func <span style=color:#e6db74>&#39;print_num&#39;</span> to
</span></span><span style=display:flex><span>			 * complete this part. Think the differences between <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;d&#39;</span> and the
</span></span><span style=display:flex><span>			 * others. <span style=color:#f92672>(</span>hint: <span style=color:#e6db74>&#39;neg_flag&#39;</span><span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>			 */
</span></span><span style=display:flex><span>			/* Exercise 1.4: Your code here. <span style=color:#f92672>(</span>8/8<span style=color:#f92672>)</span> */
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>num &lt; 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				neg_flag <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> -num;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			print_num<span style=color:#f92672>(</span>out, data, num, 10, neg_flag, width, ladjust, padc, 0<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			break;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;o&#39;</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;O&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>long_flag<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> va_arg<span style=color:#f92672>(</span>ap, long int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> va_arg<span style=color:#f92672>(</span>ap, int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			print_num<span style=color:#f92672>(</span>out, data, num, 8, 0, width, ladjust, padc, 0<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			break;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;u&#39;</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;U&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>long_flag<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> va_arg<span style=color:#f92672>(</span>ap, long int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> va_arg<span style=color:#f92672>(</span>ap, int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			print_num<span style=color:#f92672>(</span>out, data, num, 10, 0, width, ladjust, padc, 0<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			break;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;x&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>long_flag<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> va_arg<span style=color:#f92672>(</span>ap, long int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> va_arg<span style=color:#f92672>(</span>ap, int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			print_num<span style=color:#f92672>(</span>out, data, num, 16, 0, width, ladjust, padc, 0<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			break;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;X&#39;</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>long_flag<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> va_arg<span style=color:#f92672>(</span>ap, long int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>				num <span style=color:#f92672>=</span> va_arg<span style=color:#f92672>(</span>ap, int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>			print_num<span style=color:#f92672>(</span>out, data, num, 16, 0, width, ladjust, padc, 1<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			break;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;c&#39;</span>:
</span></span><span style=display:flex><span>			c <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>char<span style=color:#f92672>)</span>va_arg<span style=color:#f92672>(</span>ap, int<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			print_char<span style=color:#f92672>(</span>out, data, c, width, ladjust<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			break;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;s&#39;</span>:
</span></span><span style=display:flex><span>			s <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>char *<span style=color:#f92672>)</span>va_arg<span style=color:#f92672>(</span>ap, char *<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			print_str<span style=color:#f92672>(</span>out, data, s, width, ladjust<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>			break;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;\0&#39;</span>:
</span></span><span style=display:flex><span>			fmt--;
</span></span><span style=display:flex><span>			break;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		default:
</span></span><span style=display:flex><span>			/* output this char as it is */
</span></span><span style=display:flex><span>			out<span style=color:#f92672>(</span>data, fmt, 1<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		fmt++;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/* --------------- local help functions --------------------- */
</span></span><span style=display:flex><span>void print_char<span style=color:#f92672>(</span>fmt_callback_t out, void *data, char c, int length, int ladjust<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	int i;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>length &lt; 1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		length <span style=color:#f92672>=</span> 1;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	const char space <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39; &#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ladjust<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		out<span style=color:#f92672>(</span>data, &amp;c, 1<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>i <span style=color:#f92672>=</span> 1; i &lt; length; i++<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			out<span style=color:#f92672>(</span>data, &amp;space, 1<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>i <span style=color:#f92672>=</span> 0; i &lt; length - 1; i++<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			out<span style=color:#f92672>(</span>data, &amp;space, 1<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		out<span style=color:#f92672>(</span>data, &amp;c, 1<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>void print_str<span style=color:#f92672>(</span>fmt_callback_t out, void *data, const char *s, int length, int ladjust<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	int i;
</span></span><span style=display:flex><span>	int len <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>	const char *s1 <span style=color:#f92672>=</span> s;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>*s1++<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		len++;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>length &lt; len<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		length <span style=color:#f92672>=</span> len;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ladjust<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		out<span style=color:#f92672>(</span>data, s, len<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>i <span style=color:#f92672>=</span> len; i &lt; length; i++<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			out<span style=color:#f92672>(</span>data, <span style=color:#e6db74>&#34; &#34;</span>, 1<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>i <span style=color:#f92672>=</span> 0; i &lt; length - len; i++<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			out<span style=color:#f92672>(</span>data, <span style=color:#e6db74>&#34; &#34;</span>, 1<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		out<span style=color:#f92672>(</span>data, s, len<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>void print_num<span style=color:#f92672>(</span>fmt_callback_t out, void *data, unsigned long u, int base, int neg_flag, int length,
</span></span><span style=display:flex><span>	       int ladjust, char padc, int upcase<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>	/* algorithm :
</span></span><span style=display:flex><span>	 *  1. prints the number from left to right in reverse form.
</span></span><span style=display:flex><span>	 *  2. fill the remaining spaces with padc <span style=color:#66d9ef>if</span> length is longer than
</span></span><span style=display:flex><span>	 *     the actual length
</span></span><span style=display:flex><span>	 *     TRICKY : <span style=color:#66d9ef>if</span> left adjusted, no <span style=color:#e6db74>&#34;0&#34;</span> padding.
</span></span><span style=display:flex><span>	 *		    <span style=color:#66d9ef>if</span> negtive, insert  <span style=color:#e6db74>&#34;0&#34;</span> padding between <span style=color:#e6db74>&#34;0&#34;</span> and number.
</span></span><span style=display:flex><span>	 *  3. <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!ladjust<span style=color:#f92672>)</span> we reverse the whole string including paddings
</span></span><span style=display:flex><span>	 *  4. otherwise we only reverse the actual string representing the num.
</span></span><span style=display:flex><span>	 */
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	int actualLength <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>	char buf<span style=color:#f92672>[</span>length + 70<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>	char *p <span style=color:#f92672>=</span> buf;
</span></span><span style=display:flex><span>	int i;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>do</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		int tmp <span style=color:#f92672>=</span> u % base;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tmp &lt;<span style=color:#f92672>=</span> 9<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			*p++ <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0&#39;</span> + tmp;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>upcase<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			*p++ <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;A&#39;</span> + tmp - 10;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			*p++ <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a&#39;</span> + tmp - 10;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		u /<span style=color:#f92672>=</span> base;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span> <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>u !<span style=color:#f92672>=</span> 0<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>neg_flag<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		*p++ <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;-&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	/* figure out actual length and adjust the maximum length */
</span></span><span style=display:flex><span>	actualLength <span style=color:#f92672>=</span> p - buf;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>length &lt; actualLength<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		length <span style=color:#f92672>=</span> actualLength;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	/* add padding */
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ladjust<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		padc <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39; &#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>neg_flag <span style=color:#f92672>&amp;&amp;</span> !ladjust <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>(</span>padc <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;0&#39;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>i <span style=color:#f92672>=</span> actualLength - 1; i &lt; length - 1; i++<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			buf<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> padc;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>		buf<span style=color:#f92672>[</span>length - 1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;-&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>i <span style=color:#f92672>=</span> actualLength; i &lt; length; i++<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>			buf<span style=color:#f92672>[</span>i<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> padc;
</span></span><span style=display:flex><span>		<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	/* prepare to reverse the string */
</span></span><span style=display:flex><span>	int begin <span style=color:#f92672>=</span> 0;
</span></span><span style=display:flex><span>	int end;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>ladjust<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		end <span style=color:#f92672>=</span> actualLength - 1;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		end <span style=color:#f92672>=</span> length - 1;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	/* adjust the string pointer */
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>end &gt; begin<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>		char tmp <span style=color:#f92672>=</span> buf<span style=color:#f92672>[</span>begin<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>		buf<span style=color:#f92672>[</span>begin<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> buf<span style=color:#f92672>[</span>end<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>		buf<span style=color:#f92672>[</span>end<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> tmp;
</span></span><span style=display:flex><span>		begin++;
</span></span><span style=display:flex><span>		end--;
</span></span><span style=display:flex><span>	<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	out<span style=color:#f92672>(</span>data, buf, length<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=三体会与感想>三、体会与感想<a hidden class=anchor aria-hidden=true href=#三体会与感想>#</a></h2><p>本次lab1花费了很长时间，主要有以下问题：</p><p>​ 1.在实现print.c时需要阅读三个文件的代码，切换起来有些不方便，导致浪费了较多时间；</p><p>​ 2.文件的每一个代码段，都大量使用宏定义和一些全局变量，需要手动grep去查找，虽然说这样是为了代码的可移植性，容错性更高，但是在实际阅读时仍然对于很多宏理解不清楚甚至混淆；</p><p>​ 3.给出的代码一般都预先定义好了变量，但由于不能理解变量名称（比如不知道带ptr的变量是指针），我在面对一块待补充的部分时有些茫然，在学习了一些变量命名规范后发现给出的变量名已经暗中提示了相关的操作，甚至提示了变量的数据类型。</p><p>往后的lab中，我一定要学习了解较多的预置知识，并且弄清楚其他的文件、宏定义、函数，了解各个文件、函数之间的层次关系，争取做到明晰多文件是如何划分的，它们又是怎么协同完成操作系统的启动的。</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://illuminateC.github.io/myblog/>My New Hugo Site</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>